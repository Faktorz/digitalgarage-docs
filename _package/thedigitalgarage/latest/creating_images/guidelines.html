<!DOCTYPE html>
<!--[if IE 8]> <html class="ie8"> <![endif]-->
<!--[if IE 9]> <html class="ie9"> <![endif]-->
<!--[if gt IE 9]><!-->
<html>
<!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Digital Garage | Creating Images | Guidelines</title>
  <link href="http://assets-digitalgarage-infra.apps.thedigitalgarage.io/stylesheets/subdomain.css" rel="stylesheet" type="text/css">
  <link href="http://assets-digitalgarage-infra.apps.thedigitalgarage.io/stylesheets/docs.css" rel="stylesheet" type="text/css"/>
  <link href="http://assets-digitalgarage-infra.apps.thedigitalgarage.io/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css"/>
  <!--
  <link href="https://raw.githubusercontent.com/thedigitalgarage/origin-web-console/master/extensions/thedigitalgarage/css/main.css" rel="stylesheet" type="text/css">
  -->
  <link href="http://assets-digitalgarage-infra.apps.thedigitalgarage.io/images/favicon.png" rel="apple-touch-icon-precomposed" type="image/png">
  <link href="http://assets-digitalgarage-infra.apps.thedigitalgarage.io/images/favicon.png" rel="shortcut icon" type="text/css">
  <!--[if IE]><link rel="shortcut icon" href="https://assets.openshift.net/content/subdomain/favicon.ico"><![endif]-->
  <!-- or, set /favicon.ico for IE10 win -->
  <meta content="Digital Garage Documentation" name="application-name">
  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="https://assets.openshift.net/content/html5shiv.js" type="text/javascript"></script>
    <script src="https://assets.openshift.net/content/respond.js" type="text/javascript"></script>
    <link href="https://assets.openshift.net/content/vendor/respond-js/respond-proxy.html" id="respond-proxy" rel="respond-proxy">
    <link href="/_images/respond.proxy.gif" id="respond-redirect" rel="respond-redirect">
    <script src="/_javascripts/respond.proxy.js" type="text/javascript"></script>
  <![endif]-->
  <script src="https://assets.openshift.net/content/modernizr.js" type="text/javascript"></script>
  <script src="https://assets.openshift.net/content/subdomain.js" type="text/javascript"></script>
  <script src="/_javascripts/bootstrap-offcanvas.js" type="text/javascript"></script>
  <script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-84210257-3', 'auto');
    ga('send', 'pageview');
</script>
</head>
<body>
  <div class="navbar navbar-default navbar-digital-garage" role="navigation">
  <div class="navbar-header">
    <a class="navbar-brand digital-garage" href="/"></a>
  </div>
</div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../index.html">Documentation</a>
      </li>
      <li class="hidden-xs active">
        <a href="../welcome/index.html">Digital Garage Discovery</a>
      </li>
      <li class="hidden-xs active">
        <a href="../creating_images/index.html">Creating Images</a>
      </li>
      
      <li class="hidden-xs active">
        Guidelines
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <div class="row-fluid">
          
<script>
  (function() {
    var cx = '013769182564158614814:e-dp46b51vk';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>

        </div>
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-right"></span>About
      </a>
      <ul id="topicGroup0" class="collapse  list-unstyled">
            <li><a class="" href="../welcome/index.html">Welcome</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup1">
        <span id="tgSpan1" class="fa fa-angle-right"></span>Getting Started
      </a>
      <ul id="topicGroup1" class="collapse  list-unstyled">
            <li><a class="" href="../getting_started/index.html">Overview</a></li>
            <li><a class="" href="../getting_started/basic_walkthrough.html">Basic Walkthrough</a></li>
            <li><a class="" href="../getting_started/beyond_the_basics.html">Beyond the Basics</a></li>
            <li><a class="" href="../getting_started/developers_console.html">Web Console Walkthrough</a></li>
            <li><a class="" href="../getting_started/developers_cli.html">Command-Line Walkthrough</a></li>
            <li><a class="" href="../getting_started/devpreview_faq.html">Developer Preview FAQ</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup2">
        <span id="tgSpan2" class="fa fa-angle-right"></span>Architecture
      </a>
      <ul id="topicGroup2" class="collapse  list-unstyled">
            <li><a class="" href="../architecture/index.html">Overview</a></li>
            <li class="nav-header">
              <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicSubGroup-2-1">
                <span id="sgSpan-2-1" class="fa fa-caret-right"></span>&nbsp;Core Concepts
              </a>
              <ul id="topicSubGroup-2-1" class="nav-tertiary list-unstyled collapse">

                  <li><a class="" href="../architecture/core_concepts/index.html">Overview</a></li>

                  <li><a class="" href="../architecture/core_concepts/containers_and_images.html">Containers and Images</a></li>

                  <li><a class="" href="../architecture/core_concepts/containers_and_images.html">Images</a></li>

                  <li><a class="" href="../architecture/core_concepts/pods_and_services.html">Pods and Services</a></li>

                  <li><a class="" href="../architecture/core_concepts/projects_and_users.html">Projects and Users</a></li>

                  <li><a class="" href="../architecture/core_concepts/builds_and_image_streams.html">Builds and Image Streams</a></li>

                  <li><a class="" href="../architecture/core_concepts/deployments.html">Deployments</a></li>

                  <li><a class="" href="../architecture/core_concepts/routes.html">Routes</a></li>

                  <li><a class="" href="../architecture/core_concepts/templates.html">Templates</a></li>
              </ul>
            </li>
            <li class="nav-header">
              <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicSubGroup-2-2">
                <span id="sgSpan-2-2" class="fa fa-caret-right"></span>&nbsp;Additional Concepts
              </a>
              <ul id="topicSubGroup-2-2" class="nav-tertiary list-unstyled collapse">

                  <li><a class="" href="../architecture/additional_concepts/overview.html">Overview</a></li>

                  <li><a class="" href="../architecture/additional_concepts/networking.html">Networking</a></li>

                  <li><a class="" href="../architecture/additional_concepts/remote_commands.html">Remote Commands</a></li>

                  <li><a class="" href="../architecture/additional_concepts/port_forwarding.html">Port Forwarding</a></li>

                  <li><a class="" href="../architecture/additional_concepts/scm.html">Source Control Management</a></li>
              </ul>
            </li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup3">
        <span id="tgSpan3" class="fa fa-angle-right"></span>CLI Reference
      </a>
      <ul id="topicGroup3" class="collapse  list-unstyled">
            <li><a class="" href="../cli_reference/index.html">Overview</a></li>
            <li><a class="" href="../cli_reference/cli_by_example_content.html">CLI by example</a></li>
            <li><a class="" href="../cli_reference/get_started_cli.html">Get Started with the CLI</a></li>
            <li><a class="" href="../cli_reference/manage_cli_profiles.html">Managing CLI Profiles</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup4">
        <span id="tgSpan4" class="fa fa-angle-right"></span>Developer Guide
      </a>
      <ul id="topicGroup4" class="collapse  list-unstyled">
            <li><a class="" href="../dev_guide/index.html">Overview</a></li>
            <li><a class="" href="../dev_guide/application_lifecycle.html">Application Life Cycle Examples</a></li>
            <li><a class="" href="../dev_guide/authentication.html">Authentication</a></li>
            <li><a class="" href="../dev_guide/projects.html">Projects</a></li>
            <li><a class="" href="../dev_guide/new_app.html">Creating New Applications</a></li>
            <li class="nav-header">
              <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicSubGroup-4-5">
                <span id="sgSpan-4-5" class="fa fa-caret-right"></span>&nbsp;Migrating Applications
              </a>
              <ul id="topicSubGroup-4-5" class="nav-tertiary list-unstyled collapse">

                  <li><a class="" href="../dev_guide/migrating_applications/index.html">Overview</a></li>

                  <li><a class="" href="../dev_guide/migrating_applications/database_applications.html">Database Applications</a></li>

                  <li><a class="" href="../dev_guide/migrating_applications/web_framework_applications.html">Web Framework Applications</a></li>

                  <li><a class="" href="../dev_guide/migrating_applications/quickstart_examples.html">QuickStart Examples</a></li>

                  <li><a class="" href="../dev_guide/migrating_applications/continuous_integration_and_deployment.html">Continuous Integration and Deployment</a></li>

                  <li><a class="" href="../dev_guide/migrating_applications/web_hooks_action_hooks.html">Webhooks and Action Hooks</a></li>

                  <li><a class="" href="../dev_guide/migrating_applications/S2I_tool.html">S2I Tool</a></li>

                  <li><a class="" href="../dev_guide/migrating_applications/support_guide.html">Support Guide</a></li>
              </ul>
            </li>
            <li class="nav-header">
              <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicSubGroup-4-6">
                <span id="sgSpan-4-6" class="fa fa-caret-right"></span>&nbsp;Application Tutorials
              </a>
              <ul id="topicSubGroup-4-6" class="nav-tertiary list-unstyled collapse">

                  <li><a class="" href="../dev_guide/app_tutorials/index.html">Overview</a></li>

                  <li><a class="" href="../dev_guide/app_tutorials/quickstarts.html">Quickstart Templates</a></li>

                  <li><a class="" href="../dev_guide/app_tutorials/ruby_on_rails.html">Ruby on Rails</a></li>

                  <li><a class="" href="../dev_guide/app_tutorials/maven_tutorial.html">Setting Up a Nexus Mirror</a></li>
              </ul>
            </li>
            <li><a class="" href="../dev_guide/ssh_environment.html">Opening a Remote Shell to Containers</a></li>
            <li><a class="" href="../dev_guide/templates.html">Templates</a></li>
            <li><a class="" href="../dev_guide/service_accounts.html">Service Accounts</a></li>
            <li><a class="" href="../dev_guide/builds.html">Builds</a></li>
            <li><a class="" href="../dev_guide/managing_images.html">Managing Images</a></li>
            <li><a class="" href="../dev_guide/compute_resources.html">Quotas and Limit Ranges</a></li>
            <li><a class="" href="../dev_guide/deployments.html">Deployments</a></li>
            <li><a class="" href="../dev_guide/getting_traffic_into_cluster.html">Getting Traffic Into The Cluster</a></li>
            <li><a class="" href="../dev_guide/routes.html">Routes</a></li>
            <li><a class="" href="../dev_guide/integrating_external_services.html">Integrating External Services</a></li>
            <li><a class="" href="../dev_guide/secrets.html">Secrets</a></li>
            <li><a class="" href="../dev_guide/configmaps.html">ConfigMaps</a></li>
            <li><a class="" href="../dev_guide/daemonsets.html">Using Daemonsets</a></li>
            <li><a class="" href="../dev_guide/pod_autoscaling.html">Pod Autoscaling</a></li>
            <li><a class="" href="../dev_guide/volumes.html">Managing Volumes</a></li>
            <li><a class="" href="../dev_guide/persistent_volumes.html">Using Persistent Volumes</a></li>
            <li><a class="" href="../dev_guide/executing_remote_commands.html">Executing Remote Commands</a></li>
            <li><a class="" href="../dev_guide/copy_files_to_container.html">Copying Files</a></li>
            <li><a class="" href="../dev_guide/port_forwarding.html">Port Forwarding</a></li>
            <li><a class="" href="../dev_guide/shared_memory.html">Shared Memory</a></li>
            <li><a class="" href="../dev_guide/application_health.html">Application Health</a></li>
            <li><a class="" href="../dev_guide/events.html">Events</a></li>
            <li><a class="" href="../dev_guide/downward_api.html">Downward API</a></li>
            <li><a class="" href="../dev_guide/environment_variables.html">Managing Environment Variables</a></li>
            <li><a class="" href="../dev_guide/jobs.html">Jobs</a></li>
            <li><a class="" href="../dev_guide/scheduled_jobs.html">Scheduled Jobs</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup5">
        <span id="tgSpan5" class="fa fa-angle-down"></span>Creating Images
      </a>
      <ul id="topicGroup5" class="collapse in list-unstyled">
            <li><a class="" href="../creating_images/index.html">Overview</a></li>
            <li><a class=" active" href="../creating_images/guidelines.html">Guidelines</a></li>
            <li><a class="" href="../creating_images/metadata.html">Image Metadata</a></li>
            <li><a class="" href="../creating_images/s2i.html">S2I Requirements</a></li>
            <li><a class="" href="../creating_images/s2i_testing.html">Testing S2I Images</a></li>
            <li><a class="" href="../creating_images/custom.html">Custom Builder</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup6">
        <span id="tgSpan6" class="fa fa-angle-right"></span>Using Images
      </a>
      <ul id="topicGroup6" class="collapse  list-unstyled">
            <li><a class="" href="../using_images/index.html">Overview</a></li>
            <li class="nav-header">
              <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicSubGroup-6-1">
                <span id="sgSpan-6-1" class="fa fa-caret-right"></span>&nbsp;Source-to-Image (S2I)
              </a>
              <ul id="topicSubGroup-6-1" class="nav-tertiary list-unstyled collapse">

                  <li><a class="" href="../using_images/s2i_images/index.html">Overview</a></li>

                  <li><a class="" href="../using_images/s2i_images/customizing_s2i_images.html">Customizing S2I images</a></li>

                  <li><a class="" href="../using_images/s2i_images/dot_net_core.html">.NET Core</a></li>

                  <li><a class="" href="../using_images/s2i_images/nodejs.html">Node.js</a></li>

                  <li><a class="" href="../using_images/s2i_images/perl.html">Perl</a></li>

                  <li><a class="" href="../using_images/s2i_images/php.html">PHP</a></li>

                  <li><a class="" href="../using_images/s2i_images/python.html">Python</a></li>

                  <li><a class="" href="../using_images/s2i_images/java.html">Java</a></li>
              </ul>
            </li>
            <li class="nav-header">
              <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicSubGroup-6-2">
                <span id="sgSpan-6-2" class="fa fa-caret-right"></span>&nbsp;Database Images
              </a>
              <ul id="topicSubGroup-6-2" class="nav-tertiary list-unstyled collapse">

                  <li><a class="" href="../using_images/db_images/index.html">Overview</a></li>

                  <li><a class="" href="../using_images/db_images/mysql.html">MySQL</a></li>

                  <li><a class="" href="../using_images/db_images/postgresql.html">PostgreSQL</a></li>

                  <li><a class="" href="../using_images/db_images/mongodb.html">MongoDB</a></li>
              </ul>
            </li>
            <li class="nav-header">
              <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicSubGroup-6-3">
                <span id="sgSpan-6-3" class="fa fa-caret-right"></span>&nbsp;Docker Images
              </a>
              <ul id="topicSubGroup-6-3" class="nav-tertiary list-unstyled collapse">

                  <li><a class="" href="../using_images/docker_images/index.html">Overview</a></li>
              </ul>
            </li>
            <li class="nav-header">
              <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicSubGroup-6-4">
                <span id="sgSpan-6-4" class="fa fa-caret-right"></span>&nbsp;Other Images
              </a>
              <ul id="topicSubGroup-6-4" class="nav-tertiary list-unstyled collapse">

                  <li><a class="" href="../using_images/other_images/index.html">Overview</a></li>

                  <li><a class="" href="../using_images/other_images/jenkins.html">Jenkins</a></li>
              </ul>
            </li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup7">
        <span id="tgSpan7" class="fa fa-angle-right"></span>REST API Reference
      </a>
      <ul id="topicGroup7" class="collapse  list-unstyled">
            <li><a class="" href="../rest_api/index.html">Overview</a></li>
            <li><a class="" href="../rest_api/openshift_v1.html">OpenShift v1</a></li>
            <li><a class="" href="../rest_api/kubernetes_v1.html">Kubernetes v1</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>Guidelines</h2>
        </div>
        <div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title"></div>
<ul class="sectlevel1">
<li><a href="#overview">Overview</a></li>
<li><a href="#general-container-image-guidelines">General Container Image Guidelines</a></li>
<li><a href="#digital-garage-specific-guidelines">Digital Garage-Specific Guidelines</a></li>
<li><a href="#external-references">External References</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When creating container images to run on Digital Garage there are a number of best
practices to consider as an image author to ensure a good experience for
consumers of those images. Because images are intended to be immutable and used
as-is, the following guidelines help ensure that your images are highly
consumable and easy to use on Digital Garage.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="general-container-image-guidelines"><a class="anchor" href="#general-container-image-guidelines"></a>General Container Image Guidelines</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following guidelines apply when creating a container image in general, and are
independent of whether the images are used on Digital Garage.</p>
</div>
<div class="paragraph">
<p><strong>Reuse Images</strong></p>
</div>
<div class="paragraph">
<p>Wherever possible, we recommend that you base your image on an appropriate
upstream image using the <code>FROM</code> statement. This ensures your image can easily
pick up security fixes from an upstream image when it is updated, rather than
you having to update your dependencies directly.</p>
</div>
<div class="paragraph">
<p>In addition, use tags in the <code>FROM</code> instruction (for example,  <code>rhel:rhel7</code>) to
make it clear to users exactly which version of an image your image is based on.
Using a tag other than <code>latest</code> ensures your image is not subjected to breaking
changes that might go into the <code>latest</code> version of an upstream image.</p>
</div>
<div class="paragraph">
<p><strong>Maintain Compatibility Within Tags</strong></p>
</div>
<div class="paragraph">
<p>When tagging your own images, we recommend that you try to maintain backwards
compatibility within a tag. For example, if you provide an image named
<em>foo</em> and it currently includes version 1.0, you might provide a tag of
<em>foo:v1</em>. When you update the image, as long as it continues to be compatible
with the original image, you can continue to tag the new image <em>foo:v1</em>, and
downstream consumers of this tag will be able to get updates without being
broken.</p>
</div>
<div class="paragraph">
<p>If you later release an incompatible update, then you should switch to a new
tag, for example <em>foo:v2</em>. This allows downstream consumers to move up to the
new version at will, but not be inadvertently broken by the new incompatible
image. Any downstream consumer using <em>foo:latest</em> takes on the risk of any
incompatible changes being introduced.</p>
</div>
<div class="paragraph">
<p><strong>Avoid Multiple Processes</strong></p>
</div>
<div class="paragraph">
<p>We recommend that you do not start multiple services, such as a database and
<strong>SSHD</strong>, inside one container. This is not necessary because containers
are lightweight and can be easily linked together for orchestrating multiple
processes. Digital Garage allows you to easily colocate and co-manage related images
by grouping them into a single pod.</p>
</div>
<div class="paragraph">
<p>This colocation ensures the containers share a network namespace and storage
for communication. Updates are also less disruptive as each image can be updated
less frequently and independently. Signal handling flows are also clearer with a
single process as you do not need to manage routing signals to spawned
processes.</p>
</div>
<div class="paragraph">
<p><strong>Use <code>exec</code> in Wrapper Scripts</strong></p>
</div>
<div class="paragraph">
<p>See the "Always <code>exec</code> in Wrapper Scripts" section of the
<a href="http://www.projectatomic.io/docs/docker-image-author-guidance">Project Atomic
documentation</a> for more information.</p>
</div>
<div class="paragraph">
<p>Also note that your process runs as PID 1 when running in a container.
This means that if your main process terminates, the entire container is
stopped, killing any child processes you may have launched from your PID 1
process.</p>
</div>
<div class="paragraph">
<p>See the
<a href="http://blog.phusion.nl/2015/01/20/docker-and-the-pid-1-zombie-reaping-problem/">"Docker
and the PID 1 zombie reaping problem"</a> blog article for additional implications.
Also see the <a href="https://felipec.wordpress.com/2013/11/04/init/">"Demystifying the
init system (PID 1)"</a> blog article for a deep dive on PID 1 and <strong>init</strong>
systems.</p>
</div>
<div class="paragraph">
<p><strong>Clean Temporary Files</strong></p>
</div>
<div class="paragraph">
<p>All temporary files you create during the build process should be removed. This
also includes any files added with the <code>ADD</code> command.  For example, we strongly
recommended that you run the <code>yum clean</code> command after performing <code>yum install</code>
operations.</p>
</div>
<div class="paragraph">
<p>You can prevent the <code>yum</code> cache from ending up in an image layer by creating
your <code>RUN</code> statement as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>RUN yum -y install mypackage &amp;&amp; yum -y install myotherpackage &amp;&amp; yum clean all -y</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that if you instead write:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>RUN yum -y install mypackage
RUN yum -y install myotherpackage &amp;&amp; yum clean all -y</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then the first <code>yum</code> invocation leaves extra files in that layer, and these
files cannot be removed when the <code>yum clean</code> operation is run later. The extra
files are not visible in the final image, but they are present in the underlying
layers.</p>
</div>
<div class="paragraph">
<p>The current Docker build process does not allow a command run in a later layer
to shrink the space used by the image when something was removed in an earlier
layer. However, this may change in the future. This means that if you perform an
<code>rm</code> command in a later layer, although the files are hidden it does not reduce
the overall size of the image to be downloaded. Therefore, as with the <code>yum
clean</code> example, it is best to remove files in the same command that created
them, where possible, so they do not end up written to a layer.</p>
</div>
<div class="paragraph">
<p>In addition, performing multiple commands in a single <code>RUN</code> statement reduces
the number of layers in your image, which improves download and extraction time.</p>
</div>
<div class="paragraph">
<p><strong>Place Instructions in the Proper Order</strong></p>
</div>
<div class="paragraph">
<p>Docker reads the <strong><em>Dockerfile</em></strong> and runs the instructions from top to
bottom. Every instruction that is successfully executed creates a layer which
can be reused the next time this or another image is built. It is very important
to place instructions that will rarely change at the top of your
<strong><em>Dockerfile</em></strong>. Doing so ensures the next builds of the same image are
very fast because the cache is not invalidated by upper layer changes.</p>
</div>
<div class="paragraph">
<p>For example, if you are working on a <strong><em>Dockerfile</em></strong> that contains an <code>ADD</code>
command to install a file you are iterating on, and a <code>RUN</code> command to <code>yum
install</code> a package, it is best to put the <code>ADD</code> command last:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>FROM foo
RUN yum -y install mypackage &amp;&amp; yum clean all -y
ADD myfile /test/myfile</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This way each time you edit <strong><em>myfile</em></strong> and rerun <code>docker build</code>, the system reuses
the cached layer for the <code>yum</code> command and only generates the new layer for the
<code>ADD</code> operation.</p>
</div>
<div class="paragraph">
<p>If instead you wrote the <strong><em>Dockerfile</em></strong> as:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>FROM foo
ADD myfile /test/myfile
RUN yum -y install mypackage &amp;&amp; yum clean all -y</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then each time you changed <strong><em>myfile</em></strong> and reran <code>docker build</code>, the <code>ADD</code>
operation would invalidate the <code>RUN</code> layer cache, so the <code>yum</code> operation would
need to be rerun as well.</p>
</div>
<div class="paragraph">
<p><strong>Mark Important Ports</strong></p>
</div>
<div class="paragraph">
<p>See the "Always <code>EXPOSE</code> Important Ports" section of the
<a href="http://www.projectatomic.io/docs/docker-image-author-guidance">Project Atomic
documentation</a> for more information.</p>
</div>
<div class="paragraph">
<p><strong>Set Environment Variables</strong></p>
</div>
<div class="paragraph">
<p>It is good practice to set environment variables with the <code>ENV</code> instruction.
One example is to set the version of your project. This makes it easy for people
to find the version without looking at the <strong><em>Dockerfile</em></strong>. Another example is
advertising a path on the system that could be used by another process, such as
<code><strong>JAVA_HOME</strong></code>.</p>
</div>
<div class="paragraph">
<p><strong>Avoid Default Passwords</strong></p>
</div>
<div class="paragraph">
<p>It is best to avoid setting default passwords. Many people will extend the image
and forget to remove or change the default password. This can lead to security
issues if a user in production is assigned a well-known password. Passwords
should be configurable using an environment variable instead. See the
<a href="#use-env-vars">Using Environment Variables for Configuration</a> topic for more
information.</p>
</div>
<div class="paragraph">
<p>If you do choose to set a default password, ensure that an appropriate warning
message is displayed when the container is started. The message should inform
the user of the value of the default password and explain how to change it, such
as what environment variable to set.</p>
</div>
<div class="paragraph">
<p><strong>Avoid SSHD</strong></p>
</div>
<div class="paragraph">
<p>It is best to avoid running <strong>SSHD</strong> in your image. For accessing running
containers, You can use the <code>docker exec</code> command locally to access containers
that are running. Alternatively, you can use the Digital Garage tooling since
it allows you to execute arbitrary commands in images that are running.
Installing and running <strong>SSHD</strong> in your image opens up additional vectors for
attack and requirements for security patching.</p>
</div>
<div class="paragraph">
<p><strong>Use Volumes for Persistent Data</strong></p>
</div>
<div class="paragraph">
<p>Images should use a <a href="https://docs.docker.com/reference/builder/#volume">Docker
volume</a> for persistent data. This way Digital Garage mounts the network storage
to the node running the container, and if the container moves to a new node the
storage is reattached to that node. By using the volume for all persistent
storage needs, the content is preserved even if the container is restarted or
moved. If your image writes data to arbitrary locations within the container,
that content might not be preserved.</p>
</div>
<div class="paragraph">
<p>All data that needs to be preserved even after the container is destroyed must
be written to a volume.  With Docker 1.5, there will be a <code>readonly</code> flag for
containers which can be used to strictly enforce good practices about not
writing data to ephemeral storage in a container. Designing your image around
that capability now will make it easier to take advantage of it later.</p>
</div>
<div class="paragraph">
<p>Furthermore, explicitly defining volumes in your <strong><em>Dockerfile</em></strong> makes it easy
for consumers of the image to understand what volumes they need to define when
running your image.</p>
</div>
<div class="paragraph">
<p>See the
<a href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/user-guide/volumes.md">Kubernetes
documentation</a> for more information on how volumes are used in Digital Garage.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even with persistent volumes, each instance of your image has its own
volume, and the filesystem is not shared between instances.  This means the
volume cannot be used to share state in a cluster.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>External Guidelines</strong></p>
</div>
<div class="paragraph">
<p>See the following references for other guidelines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Docker documentation - <a href="https://docs.docker.com/articles/dockerfile_best-practices/">Best practices for writing Dockerfiles</a></p>
</li>
<li>
<p>Project Atomic documentation - <a href="http://www.projectatomic.io/docs/docker-image-author-guidance/">Guidance for Container Image Authors</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="digital-garage-specific-guidelines"><a class="anchor" href="#digital-garage-specific-guidelines"></a>Digital Garage-Specific Guidelines</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following are guidelines that apply when creating container images specifically
for use on Digital Garage.</p>
</div>
<div class="paragraph">
<p><strong>Enable Images for Source-To-Image (S2I)</strong></p>
</div>
<div class="paragraph">
<p>For images that are intended to run application code provided by a third party,
such as a Ruby image designed to run Ruby code provided by a developer, you can
enable your image to work with the
<a href="https://github.com/openshift/source-to-image">Source-to-Image (S2I)</a>  build tool.
S2I is a framework which makes it easy to write images that take application
source code as an input and produce a new image that runs the assembled
application as output.</p>
</div>
<div class="paragraph">
<p>For example, this <a href="https://github.com/openshift/sti-python">Python image</a>
defines S2I scripts for building various versions of Python applications.</p>
</div>
<div class="paragraph">
<p>For more details about how to write S2I scripts for your image, see the
<a href="s2i.html#creating-images-s2i">S2I Requirements</a> topic.</p>
</div>
<div id="use-uid" class="paragraph">
<p><strong>Support Arbitrary User IDs</strong></p>
</div>
<div class="paragraph">
<p>By default, Digital Garage runs containers using an arbitrarily assigned user
ID. This provides additional security against processes escaping the container
due to a container engine vulnerability and thereby achieves escalated
permissions on the host node.</p>
</div>
<div class="paragraph">
<p>For an image to support running as an arbitray user, directories and files that
may be written to by processes in the image should be owned by the root group
and be read/writable by that group. Files to be executed should also have group
execute permissions.</p>
</div>
<div class="paragraph">
<p>Adding the following to your Dockerfile sets the directory and file permissions
to allow users in the root group to access them in the built image:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>RUN chgrp -R 0 /some/directory
RUN chmod -R g+rw /some/directory
RUN find /some/directory -type d -exec chmod g+x {} +</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Because the container user is always a member of the root group, the container
user can read and write these files. The root group does not have any special
permissions (unlike the root user) so there are no security concerns with this
arrangement. In addition, the processes running in the container must not listen
on privileged ports (ports below 1024), since they are not running as a
privileged user.</p>
</div>
<div class="paragraph">
<p>Because the user ID of the container is generated dynamically, it will not have
an associated entry in <strong><em>/etc/passwd</em></strong>. This can cause problems for applications
that expect to be able to look up their user ID. One way to address this problem
is to use <a href="https://cwrap.org/nss_wrapper.html">nss wrapper</a> and dynamically
create a <strong><em>passwd</em></strong> file with the container&#8217;s user ID as part of the image&#8217;s
start script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>export USER_ID=$(id -u)
export GROUP_ID=$(id -g)
envsubst &lt; ${HOME}/passwd.template &gt; /tmp/passwd
export LD_PRELOAD=libnss_wrapper.so
export NSS_WRAPPER_PASSWD=/tmp/passwd
export NSS_WRAPPER_GROUP=/etc/group</pre>
</div>
</div>
<div class="paragraph">
<p>Where <strong><em>passwd.template</em></strong> contains:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/spool/mail:/sbin/nologin
operator:x:11:0:operator:/root:/sbin/nologin
games:x:12:100:games:/usr/games:/sbin/nologin
ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin
nobody:x:99:99:Nobody:/:/sbin/nologin
postgres:x:${USER_ID}:${GROUP_ID}:PostgreSQL Server:${HOME}:/bin/bash</pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, you must install the <strong>nss_wrapper</strong> and <strong>gettext</strong> packages in your
image for this to work. The latter provides the <code>envsubst</code> command. For
example you can add this line to your <strong><em>Dockerfile</em></strong> for yum-based  images:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>RUN yum -y install nss_wrapper gettext</pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, the final <strong>USER</strong> declaration in the <code>Dockerfile</code> should specify the user
ID (numeric value) and not the user name. This allows Digital Garage to
validate the authority the image is attempting to run with and prevent running
images that are trying to run as root, because running containers as a
privileged user exposes
If the image does not specify a <strong>USER</strong>, it inherits the <strong>USER</strong>
from the parent image.</p>
</div>
<div id="use-services" class="paragraph">
<p><strong>Use Services for Inter-image Communication</strong></p>
</div>
<div class="paragraph">
<p>For cases where your image needs to communicate with a service provided by
another image, such as a web front end image that needs to access a database
image to store and retrieve data, your image should consume an Digital Garage
<a href="../architecture/core_concepts/pods_and_services.html#services">service</a>.
Services provide a static endpoint for access which does not change as
containers are stopped, started, or moved. In addition, services provide load
balancing for requests.</p>
</div>
<div class="paragraph">
<p><strong>Provide Common Libraries</strong></p>
</div>
<div class="paragraph">
<p>For images that are intended to run application code provided by a third party,
ensure that your image contains commonly used libraries for your platform. In
particular, provide database drivers for common databases used with your
platform. For example, provide JDBC drivers for MySQL and PostgreSQL if you are
creating a Java framework image. Doing so prevents the need for common
dependencies to be downloaded during application assembly time, speeding up
application image builds. It also simplifies the work required by application
developers to ensure all of their dependencies are met.</p>
</div>
<div id="use-env-vars" class="paragraph">
<p><strong>Use Environment Variables for Configuration</strong></p>
</div>
<div class="paragraph">
<p>Users of your image should be able to configure it without having to create a
downstream image based on your image. This means that the runtime configuration
should be handled using environment variables. For a simple configuration, the
running process can consume the environment variables directly. For a more
complicated configuration or for runtimes which do not support this, configure
the runtime by defining a template configuration file that is processed during
startup. During this processing, values supplied using environment variables can
be substituted into the configuration file or used to make decisions about what
options to set in the configuration file.</p>
</div>
<div class="paragraph">
<p>It is also possible and recommended to pass secrets such as certificates and
keys into the container using environment variables. This ensures that the
secret values do not end up committed in an image and leaked into a Docker
registry.</p>
</div>
<div class="paragraph">
<p>Providing environment variables allows consumers of your image to customize
behavior, such as database settings, passwords, and performance tuning, without
having to introduce a new layer on top of your image. Instead, they can simply
define environment variable values when defining a pod and change those settings
without rebuilding the image.</p>
</div>
<div class="paragraph">
<p>For extremely complex scenarios, configuration can also be supplied using
volumes that would be mounted into the container at runtime. However, if you
elect to do it this way you must ensure that your image provides clear error
messages on startup when the necessary volume or configuration is not present.</p>
</div>
<div class="paragraph">
<p>This topic is related to the <a href="#use-services">Using Services for Inter-image
Communication</a> topic in that configuration like datasources should be defined in
terms of environment variables that provide the service endpoint information.
This allows an application to dynamically consume a datasource service that is
defined in the Digital Garage environment without modifying the application
image.</p>
</div>
<div class="paragraph">
<p>In addition, tuning should be done by inspecting the <strong>cgroups</strong> settings
for the container. This allows the image to tune itself to the available memory,
CPU, and other resources. For example, Java-based images should tune their heap
based on the <strong>cgroup</strong> maximum memory parameter to ensure they do not
exceed the limits and get an out-of-memory error.</p>
</div>
<div class="paragraph">
<p>See the following references for more on how to manage <strong>cgroup</strong> quotas
in Docker containers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Blog article - <a href="https://goldmann.pl/blog/2014/09/11/resource-management-in-docker">Resource management in Docker</a></p>
</li>
<li>
<p>Docker documentation - <a href="https://docs.docker.com/articles/runmetrics">Runtime Metrics</a></p>
</li>
<li>
<p>Blog article - <a href="http://fabiokung.com/2014/03/13/memory-inside-linux-containers">Memory inside Linux containers</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Set Image Metadata</strong></p>
</div>
<div class="paragraph">
<p>Defining image metadata helps Digital Garage better consume your container images,
allowing Digital Garage to create a better experience for developers using your
image. For example, you can add metadata to provide helpful descriptions of your
image, or offer suggestions on other images that may also be needed.</p>
</div>
<div class="paragraph">
<p>See the <a href="metadata.html#creating-images-metadata">Image Metadata</a> topic for more information on
supported metadata and how to define them.</p>
</div>
<div class="paragraph">
<p><strong>Clustering</strong></p>
</div>
<div class="paragraph">
<p>You must fully understand what it means to run multiple instances of your image.
In the simplest case, the load balancing function of a service handles routing
traffic to all instances of your image.  However, many frameworks need to share
information in order to perform leader election or failover state; for example,
in session replication.</p>
</div>
<div class="paragraph">
<p>Consider how your instances accomplish this communication when running in
Digital Garage. Although pods can communicate directly with each other, their
IP addresses change anytime the pod starts, stops, or is moved. Therefore, it is
important for your clustering scheme to be dynamic.</p>
</div>
<div class="paragraph">
<p><strong>Logging</strong></p>
</div>
<div class="paragraph">
<p>It is best to send all logging to standard out. Digital Garage collects
standard out from containers and sends it to the centralized logging service
where it can be viewed. If you need to separate log content, prefix the output
with an appropriate keyword, which makes it possible to filter the messages.</p>
</div>
<div class="paragraph">
<p>If your image logs to a file, users must use manual operations to enter the
running container and retrieve or view the log file.</p>
</div>
<div class="paragraph">
<p><strong>Liveness and Readiness Probes</strong></p>
</div>
<div class="paragraph">
<p>Document example
<a href="../dev_guide/application_health.html#container-health-checks-using-probes">liveness
and readiness probes</a> that can be used with your image. These probes will allow
users to deploy your image with confidence that traffic will not be routed to
the container until it is prepared to handle it, and that the container will be
restarted if the process gets into an unhealthy state.</p>
</div>
<div class="paragraph">
<p><strong>Templates</strong></p>
</div>
<div class="paragraph">
<p>Consider providing an example <a href="../dev_guide/templates.html#dev-guide-templates">template</a> with
your image. A template will give users an easy way to quickly get your image
deployed with a working configuration. Your template should include the
<a href="../dev_guide/application_health.html#container-health-checks-using-probes">liveness
and readiness probes</a> you documented with the image, for completeness.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="external-references"><a class="anchor" href="#external-references"></a>External References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.docker.com/engine/userguide/basics/">Docker basics</a></p>
</li>
<li>
<p><a href="https://docs.docker.com/reference/builder">Dockerfile reference</a></p>
</li>
<li>
<p><a href="http://www.projectatomic.io/docs/docker-image-author-guidance">Project Atomic Guidance for Container Image Authors</a></p>
</li>
</ul>
</div>
</div>
</div>
      </div>
    </div>
  </div>
  <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
  <footer class="footer-digital-garage">
  <div class="container">
    <div class="row">
      <div class="col-xs-12 col-sm-4 col-md-3 logo">
        <a href="https://www.thedigitalgarage.io/"></a>
      </div>
      <div class="col-xs-12 col-sm-4 col-md-6 text-center">
        <div class="row">
          <div class="col-xs-12 col-md-4">
            <a href="http://www.thedigitalgarage.io/community/digital-garage-privacy-policy/">
              Privacy Policy
            </a>
          </div>
          <div class="col-xs-12 col-md-4">
          <a href="http://www.thedigitalgarage.io/community/terms-of-service/">
            Terms of Use
          </a>
          </div>
          <div class="col-xs-12 col-md-4">
          <a href="http://www.thedigitalgarage.io/community/">
            Our Community
          </a>
          </div>
        </div>
      </div>
      <div class="col-xs-12 col-sm-4 col-md-3 text-right">
        <a id="built_with_asciibinder" href="http://asciibinder.org/">
          <img src="http://docs.thedigitalgarage.io/_images/asciibinder_web_logo.svg" alt="AsciiBinder" />
        </a>
      </div>
    </div>
  </div>
</footer>

<!-- Adobe DTM -->
<script type="text/javascript">
if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
   _satellite.pageBottom();
}
</script>
<!-- End Adobe DTM -->
</body>
</html>