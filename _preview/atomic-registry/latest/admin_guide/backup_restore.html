<!DOCTYPE html>
<!--[if IE 8]> <html class="ie8"> <![endif]-->
<!--[if IE 9]> <html class="ie9"> <![endif]-->
<!--[if gt IE 9]><!-->
<html>
<!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Atomic Registry | Cluster Administration | Backup and Restore</title>
  <link href="/_stylesheets/subdomain.css" rel="stylesheet" type="text/css">
  <link href="/_stylesheets/docs.css" rel="stylesheet" type="text/css"/>
  <link href="/_stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css"/>
  <!--
  <link href="https://raw.githubusercontent.com/thedigitalgarage/origin-web-console/master/extensions/thedigitalgarage/css/main.css" rel="stylesheet" type="text/css">
  -->
  <link href="/_images/favicon.png" rel="apple-touch-icon-precomposed" type="image/png">
  <link href="/_images/favicon.png" rel="shortcut icon" type="text/css">
  <!--[if IE]><link rel="shortcut icon" href="https://assets.openshift.net/content/subdomain/favicon.ico"><![endif]-->
  <!-- or, set /favicon.ico for IE10 win -->
  <meta content="the Digital Garage" name="application-name">
  <meta content="#000000" name="msapplication-TileColor">
  <meta content="https://assets.openshift.net/content/subdomain/touch-icon-precomposed.png" name="msapplication-TileImage">
  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="https://assets.openshift.net/content/html5shiv.js" type="text/javascript"></script>
    <script src="https://assets.openshift.net/content/respond.js" type="text/javascript"></script>
    <link href="https://assets.openshift.net/content/vendor/respond-js/respond-proxy.html" id="respond-proxy" rel="respond-proxy">
    <link href="/_images/respond.proxy.gif" id="respond-redirect" rel="respond-redirect">
    <script src="/_javascripts/respond.proxy.js" type="text/javascript"></script>
  <![endif]-->
  <script src="https://assets.openshift.net/content/modernizr.js" type="text/javascript"></script>
  <script src="https://assets.openshift.net/content/subdomain.js" type="text/javascript"></script>
  <script src="/_javascripts/bootstrap-offcanvas.js" type="text/javascript"></script>
  <script src="https://assets.openshift.net/app/assets/site/tracking.js" type="text/javascript"></script>
  <script type="text/javascript" src="https://assets.openshift.net/app/assets/site/tracking.js"></script>
</head>
<body>
  <div class="navbar navbar-default navbar-openshift" role="navigation">
  <div class="navbar-header">
    <a class="navbar-brand" href="/"></a>
  </div>
  <div class="navbar-collapse collapse">
  </div>
</div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../index.html">Atomic Registry Documentation</a>
      </li>
      <li class="hidden-xs active">
        <a href="../registry_quickstart/index.html">Atomic Registry Latest</a>
      </li>
      <li class="hidden-xs active">
        <a href="../admin_guide/index.html">Cluster Administration</a>
      </li>
      
      <li class="hidden-xs active">
        Backup and Restore
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <div class="row-fluid">
          
<script>
  (function() {
    var cx = '013769182564158614814:e-dp46b51vk';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>

        </div>
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-right"></span>Quickstart
      </a>
      <ul id="topicGroup0" class="collapse  list-unstyled">
            <li><a class="" href="../registry_quickstart/index.html">Overview</a></li>
            <li><a class="" href="../registry_quickstart/developers.html">Developers</a></li>
            <li class="nav-header">
              <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicSubGroup-0-2">
                <span id="sgSpan-0-2" class="fa fa-caret-right"></span>&nbsp;Administrators
              </a>
              <ul id="topicSubGroup-0-2" class="nav-tertiary list-unstyled collapse">

                  <li><a class="" href="../registry_quickstart/administrators/index.html">Overview</a></li>

                  <li><a class="" href="../registry_quickstart/administrators/system_configuration.html">System Configuration</a></li>

                  <li><a class="" href="../registry_quickstart/administrators/uninstall.html">Uninstall</a></li>
              </ul>
            </li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup1">
        <span id="tgSpan1" class="fa fa-angle-right"></span>Architecture
      </a>
      <ul id="topicGroup1" class="collapse  list-unstyled">
            <li class="nav-header">
              <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicSubGroup-1-0">
                <span id="sgSpan-1-0" class="fa fa-caret-right"></span>&nbsp;Core Concepts
              </a>
              <ul id="topicSubGroup-1-0" class="nav-tertiary list-unstyled collapse">

                  <li><a class="" href="../architecture/core_concepts/containers_and_images.html">Images</a></li>

                  <li><a class="" href="../architecture/core_concepts/projects_and_users.html">Projects and Users</a></li>

                  <li><a class="" href="../architecture/core_concepts/builds_and_image_streams.html">Image Streams</a></li>
              </ul>
            </li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup2">
        <span id="tgSpan2" class="fa fa-angle-right"></span>Installation and Configuration
      </a>
      <ul id="topicGroup2" class="collapse  list-unstyled">
            <li><a class="" href="../install_config/adding_hosts_to_existing_cluster.html">Adding Hosts to an Existing Cluster</a></li>
            <li><a class="" href="../install_config/certificate_customization.html">Configuring Custom Certificates</a></li>
            <li><a class="" href="../install_config/redeploying_certificates.html">Redeploying Certificates</a></li>
            <li><a class="" href="../install_config/configuring_authentication.html">Configuring Authentication and User Agent</a></li>
            <li><a class="" href="../install_config/syncing_groups_with_ldap.html">Syncing Groups With LDAP</a></li>
            <li class="nav-header">
              <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicSubGroup-2-5">
                <span id="sgSpan-2-5" class="fa fa-caret-right"></span>&nbsp;Advanced LDAP Configuration
              </a>
              <ul id="topicSubGroup-2-5" class="nav-tertiary list-unstyled collapse">

                  <li><a class="" href="../install_config/advanced_ldap_configuration/index.html">Overview</a></li>

                  <li><a class="" href="../install_config/advanced_ldap_configuration/sssd_for_ldap_failover.html">Setting up SSSD for LDAP Failover</a></li>

                  <li><a class="" href="../install_config/advanced_ldap_configuration/configuring_form_based_authentication.html">Configuring Form-Based Authentication</a></li>

                  <li><a class="" href="../install_config/advanced_ldap_configuration/configuring_extended_ldap_attributes.html">Configuring Extended LDAP Attributes</a></li>
              </ul>
            </li>
            <li><a class="" href="../install_config/web_console_customization.html">Customizing the Web Console</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup3">
        <span id="tgSpan3" class="fa fa-angle-down"></span>Cluster Administration
      </a>
      <ul id="topicGroup3" class="collapse in list-unstyled">
            <li><a class="" href="../admin_guide/index.html">Overview</a></li>
            <li><a class="" href="../admin_guide/manage_users.html">Managing Users</a></li>
            <li><a class="" href="../admin_guide/managing_projects.html">Managing Projects</a></li>
            <li><a class="" href="../admin_guide/managing_pods.html">Managing Pods</a></li>
            <li><a class="" href="../admin_guide/service_accounts.html">Configuring Service Accounts</a></li>
            <li><a class="" href="../admin_guide/manage_authorization_policy.html">Managing Authorization Policies</a></li>
            <li><a class="" href="../admin_guide/image_policy.html">Image Policy</a></li>
            <li><a class="" href="../admin_guide/quota.html">Setting Quotas</a></li>
            <li><a class="" href="../admin_guide/multiproject_quota.html">Setting Multi-Project Quotas</a></li>
            <li><a class="" href="../admin_guide/limits.html">Setting Limit Ranges</a></li>
            <li><a class="" href="../admin_guide/allocating_node_resources.html">Allocating Node Resources</a></li>
            <li><a class="" href="../admin_guide/tcp_ingress_external_ports.html">Assigning Unique External IPs for Ingress Traffic</a></li>
            <li><a class=" active" href="../admin_guide/backup_restore.html">Backup and Restore</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup4">
        <span id="tgSpan4" class="fa fa-angle-right"></span>User Guide
      </a>
      <ul id="topicGroup4" class="collapse  list-unstyled">
            <li><a class="" href="../dev_guide/index.html">Overview</a></li>
            <li><a class="" href="../dev_guide/authentication.html">Authentication</a></li>
            <li><a class="" href="../dev_guide/managing_images.html">Managing Images</a></li>
            <li><a class="" href="../dev_guide/service_accounts.html">Service Accounts</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup5">
        <span id="tgSpan5" class="fa fa-angle-right"></span>CLI Reference
      </a>
      <ul id="topicGroup5" class="collapse  list-unstyled">
            <li><a class="" href="../cli_reference/index.html">Overview</a></li>
            <li><a class="" href="../cli_reference/get_started_cli.html">Get Started with the CLI</a></li>
            <li><a class="" href="../cli_reference/manage_cli_profiles.html">Managing CLI Profiles</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup6">
        <span id="tgSpan6" class="fa fa-angle-right"></span>REST API Reference
      </a>
      <ul id="topicGroup6" class="collapse  list-unstyled">
            <li><a class="" href="../rest_api/index.html">Overview</a></li>
            <li><a class="" href="../rest_api/openshift_v1.html">OpenShift v1</a></li>
            <li><a class="" href="../rest_api/kubernetes_v1.html">Kubernetes v1</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>Backup and Restore</h2>
        </div>
        <div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title"></div>
<ul class="sectlevel1">
<li><a href="#overview">Overview</a></li>
<li><a href="#backup-restore-prerequisites">Prerequisites</a></li>
<li><a href="#cluster-backup">Cluster Backup</a></li>
<li><a href="#cluster-restore">Cluster Restore</a></li>
<li><a href="#project-backup">Project Backup</a>
<ul class="sectlevel2">
<li><a href="#backup-rolebindings">Role Bindings</a></li>
<li><a href="#backup-serviceaccounts">Service Accounts</a></li>
<li><a href="#backup-secrets">Secrets</a></li>
<li><a href="#backup-pvc">Persistent Volume Claims</a></li>
</ul>
</li>
<li><a href="#project-restore">Project Restore</a></li>
<li><a href="#backup-application-data">Application Data Backup</a></li>
<li><a href="#restore-application-data">Application Data Restore</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Atomic Registry, you can <em>back up</em> (saving state to separate storage) and
<em>restore</em> (recreating state from separate storage) at the cluster level. There
is also some preliminary support for <a href="#project-backup">per-project backup</a>.
The full state of a cluster installation includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>etcd data on each master</p>
</li>
<li>
<p>API objects</p>
</li>
<li>
<p>registry storage</p>
</li>
<li>
<p>volume storage</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This topic does not cover how to back up and restore
<a href="../install_config/persistent_storage/index.html#install-config-persistent-storage-index">persistent
storage</a>, as those topics are left to the underlying storage provider. However,
an example of how to perform a <strong>generic</strong> backup of
<a href="#backup-application-data">application data</a> is provided.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This topic only provides a generic way of backing up applications and the
Atomic Registry cluster. It can not take into account custom requirements.
Therefore, you should create a full backup and restore procedure. To prevent
data loss, necessary precautions should be taken.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="backup-restore-prerequisites"><a class="anchor" href="#backup-restore-prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Because the restore procedure involves a <a href="#cluster-restore">complete
reinstallation</a>, save all the files used in the initial installation. This may
include:</p>
<div class="ulist">
<ul>
<li>
<p><strong><em>~/.config/openshift/installer.cfg.yml</em></strong> (from the
<a href="../install_config/install/quick_install.html#install-config-install-quick-install">Quick Installation</a>
method)</p>
</li>
<li>
<p>Ansible playbooks and inventory files (from the
<a href="../install_config/install/advanced_install.html#install-config-install-advanced-install">Advanced
Installation</a> method)</p>
</li>
<li>
<p><strong><em>/etc/yum.repos.d/ose.repo</em></strong> (from the
<a href="../install_config/install/disconnected_install.html#install-config-install-disconnected-install">Disconnected
Installation</a> method)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Backup the procedures for post-installation steps. Some installations may
involve steps that are not included in the installer. This may include changes
to the services outside of the control of Atomic Registry or the installation of
extra services like monitoring agents.
Additional configuration that is not supported yet by the advanced installer
might also be affected, for example when using multiple authentication providers.</p>
</li>
<li>
<p>Install packages that provide various utility commands:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install etcd</pre>
</div>
</div>
</li>
<li>
<p>If using a containerized installation, pull the etcd image instead:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># docker pull rhel7/etcd</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note the location of the <strong>etcd</strong> data directory (or <code>$ETCD_DATA_DIR</code> in the
following sections), which depends on how <strong>etcd</strong> is deployed.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Deployment Type</th>
<th class="tableblock halign-left valign-top">Data Directory</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">all-in-one cluster</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>/var/lib/openshift/openshift.local.etcd</em></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">external etcd (not on master)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>/var/lib/etcd</em></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">embedded etcd (on master)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><em>/var/lib/origin/etcd</em></strong></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="cluster-backup"><a class="anchor" href="#cluster-backup"></a>Cluster Backup</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Save all the certificates and keys, on each master:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cd /etc/origin/master
# tar cf /tmp/certs-and-keys-$(hostname).tar \
    master.proxy-client.crt \
    master.proxy-client.key \
    proxyca.crt \
    proxyca.key \
    master.server.crt \
    master.server.key \
    ca.crt \
    ca.key \
    master.etcd-client.crt \
    master.etcd-client.key \
    master.etcd-ca.crt</pre>
</div>
</div>
</li>
<li>
<p>If <strong>etcd</strong> is running on more than one host, stop it on each host:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># sudo systemctl stop etcd</pre>
</div>
</div>
<div class="paragraph">
<p>Although this step is not strictly necessary, doing so ensures that the <strong>etcd</strong>
data is fully synchronized.</p>
</div>
</li>
<li>
<p>Create an <strong>etcd</strong> backup:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># etcdctl backup \
    --data-dir $ETCD_DATA_DIR \
    --backup-dir $ETCD_DATA_DIR.bak</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If <strong>etcd</strong> is running on more than one host,
the various instances regularly synchronize their data,
so creating a backup for one of them is sufficient.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For a containerized installation, you must use <code>docker exec</code> to run <strong>etcdctl</strong>
inside the container.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create a template for all cluster API objects:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc export all \
    --exact \<i class="conum" data-value="1"></i><b>(1)</b>
    --all-namespaces \
    --as-template=mycluster \<i class="conum" data-value="2"></i><b>(2)</b>
    &gt; mycluster.template.yaml</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Preserve fields that may be cluster specific,
such as service <code>portalIP</code> values or generated names.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The output file has <code>kind: Template</code> and <code>metadata.name: mycluster</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>The object types included in <code>oc export all</code> are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>BuildConfig</p>
</li>
<li>
<p>Build</p>
</li>
<li>
<p>DeploymentConfig</p>
</li>
<li>
<p>ImageStream</p>
</li>
<li>
<p>Pod</p>
</li>
<li>
<p>ReplicationController</p>
</li>
<li>
<p>Route</p>
</li>
<li>
<p>Service</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cluster-restore"><a class="anchor" href="#cluster-restore"></a>Cluster Restore</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Reinstall Atomic Registry.</p>
<div class="paragraph">
<p>This should be done in the
<a href="../install_config/index.html#install-config-index">same way</a>
that Atomic Registry was previously installed.</p>
</div>
</li>
<li>
<p>Run all necessary post-installation steps.</p>
</li>
<li>
<p>Restore the certificates and keys, on each master:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cd /etc/origin/master
# tar xvf /tmp/certs-and-keys-$(hostname).tar</pre>
</div>
</div>
</li>
<li>
<p>Restore from the <strong>etcd</strong> backup:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mv $ETCD_DATA_DIR $ETCD_DATA_DIR.orig
# cp -Rp $ETCD_DATA_DIR.bak $ETCD_DATA_DIR
# chcon -R --reference $ETCD_DATA_DIR.orig $ETCD_DATA_DIR
# chown -R etcd:etcd $ETCD_DATA_DIR</pre>
</div>
</div>
</li>
<li>
<p>Create the API objects for the cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc create -f mycluster.template.yaml</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="project-backup"><a class="anchor" href="#project-backup"></a>Project Backup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A future release of Atomic Registry will feature specific support for
per-project back up and restore.</p>
</div>
<div class="paragraph">
<p>For now, to back up API objects at the project level, use <code>oc export</code> for each
object to be saved. For example, to save the deployment configuration <code>frontend</code>
in YAML format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc export dc frontend -o yaml &gt; dc-frontend.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>To back up all of the project (with the exception of cluster objects like
namespaces and projects):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc export all -o yaml &gt; project.yaml</pre>
</div>
</div>
<div class="sect2">
<h3 id="backup-rolebindings"><a class="anchor" href="#backup-rolebindings"></a>Role Bindings</h3>
<div class="paragraph">
<p>Sometimes custom policy
<a href="../admin_guide/manage_authorization_policy.html#managing-role-bindings">role
bindings</a> are used in a project. For example, a project administrator can give
another user a certain role in the project and grant that user project access.</p>
</div>
<div class="paragraph">
<p>These role bindings can be exported:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get rolebindings -o yaml --export=true &gt; rolebindings.yaml</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backup-serviceaccounts"><a class="anchor" href="#backup-serviceaccounts"></a>Service Accounts</h3>
<div class="paragraph">
<p>If custom service accounts are created in a project, these need to be exported:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get serviceaccount -o yaml --export=true &gt; serviceaccount.yaml</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backup-secrets"><a class="anchor" href="#backup-secrets"></a>Secrets</h3>
<div class="paragraph">
<p>Custom secrets like source control management secrets (SSH Public Keys,
Username/Password) should be exported if they are used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get secret -o yaml --export=true &gt; secret.yaml</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backup-pvc"><a class="anchor" href="#backup-pvc"></a>Persistent Volume Claims</h3>
<div class="paragraph">
<p>If the an application within a project uses a persistent volume through a
persistent volume claim (PVC), these should be backed up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get pvc -o yaml --export=true &gt; pvc.yaml</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="project-restore"><a class="anchor" href="#project-restore"></a>Project Restore</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To restore a project, recreate the project and recreate all all of the objects
that were exported during the backup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc new-project myproject
$ oc create -f project.yaml
$ oc create -f secret.yaml
$ oc create -f serviceaccount.yaml
$ oc create -f pvc.yaml
$ oc create -f rolebindings.yaml</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some resources can fail to be created (for example, pods and default service
accounts).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="backup-application-data"><a class="anchor" href="#backup-application-data"></a>Application Data Backup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In many cases, application data can be backed up using the <code>oc rsync</code> command,
assuming <code>rsync</code> is installed within the container image. The Red Hat <strong>rhel7</strong>
base image does contain <code>rsync</code>. Therefore, all images that are based on <strong>rhel7</strong>
contain it as well.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is a <em>generic</em> backup of application data and does not take into account
application-specific backup procedures, for example special export/import
procedures for database systems.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Other means of backup may exist depending on the type of the persistent volume
(for example, Cinder, NFS, Gluster, or others).</p>
</div>
<div class="paragraph">
<p>The paths to back up are also <em>application specific</em>. You can determine
what path to back up by looking at the <code><strong>mountPath</strong></code> for volumes in the
<code><strong>deploymentconfig</strong></code>.</p>
</div>
<div class="olist arabic">
<div class="title">Example of Backing up a Jenkins Deployment&#8217;s Application Data</div>
<ol class="arabic">
<li>
<p>Get the application data <code><strong>mountPath</strong></code> from the <code><strong>deploymentconfig</strong></code>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc export dc/jenkins|grep mountPath
        - mountPath: /var/lib/jenkins</pre>
</div>
</div>
</li>
<li>
<p>Get the name of the pod that is currently running:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc get po --selector=deploymentconfig=jenkins
NAME              READY     STATUS    RESTARTS   AGE
jenkins-1-a3347   1/1       Running   0          18h</pre>
</div>
</div>
</li>
<li>
<p>Use the <code>oc rsync</code> command to copy application data:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc rsync jenkins-1-37nux:/var/lib/jenkins /tmp/</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This type of application data backup can only be performed while an application
pod is currently running.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="restore-application-data"><a class="anchor" href="#restore-application-data"></a>Application Data Restore</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The process for restoring application data is similar to the
<a href="#backup-application-data">application backup procedure</a> using the <code>oc rsync</code>
tool. The same restrictions apply and the process of restoring application data
requires a persistent volume.</p>
</div>
<div class="olist arabic">
<div class="title">Example of Restoring a Jenkins Deployment&#8217;s Application Data</div>
<ol class="arabic">
<li>
<p>Verify the backup:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ ls -la /tmp/jenkins-backup/
total 8
drwxrwxr-x.  3 user     user   20 Sep  6 11:14 .
drwxrwxrwt. 17 root     root 4096 Sep  6 11:16 ..
drwxrwsrwx. 12 user     user 4096 Sep  6 11:14 jenkins</pre>
</div>
</div>
</li>
<li>
<p>Use the <code>oc rsync</code> tool to copy the data into the running pod:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc rsync /tmp/jenkins-backup/jenkins jenkins-1-37nux:/var/lib</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Depending on the application, you may be required to restart the application.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Restart the application with new data (<em>optional</em>):</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc delete po jenkins-1-37nux</pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can scale down the deployment to 0, and then up again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ oc scale --replicas=0 dc/jenkins
$ oc scale --replicas=1 dc/jenkins</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
      </div>
    </div>
  </div>
  <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
    <footer class="footer-openshift">
  <div class="container">
    <div class="row">
      <div class="col-xs-12 col-sm-4 col-md-3">
      </div>
      <div class="col-xs-12 col-sm-4 col-md-6 text-center">
        <div class="row">
          <div class="col-xs-12 col-md-4">
          </div>
          <div class="col-xs-12 col-md-4">
          </div>
          <div class="col-xs-12 col-md-4">
          </div>
        </div>
      </div>
      <div class="col-xs-12 col-sm-4 col-md-3 text-right">
        <a id="built_with_asciibinder" href="http://asciibinder.org/">
          <img src="http://docs.thedigitalgarage.io/_images/asciibinder_web_logo.svg" alt="AsciiBinder" />
        </a>
      </div>
    </div>
  </div>
</footer>
</body>
</html>