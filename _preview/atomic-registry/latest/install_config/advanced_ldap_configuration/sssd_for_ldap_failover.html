<!DOCTYPE html>
<!--[if IE 8]> <html class="ie8"> <![endif]-->
<!--[if IE 9]> <html class="ie9"> <![endif]-->
<!--[if gt IE 9]><!-->
<html>
<!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Atomic Registry | Installation and Configuration | Advanced LDAP Configuration | Setting up SSSD for LDAP Failover</title>
  <link href="/_stylesheets/subdomain.css" rel="stylesheet" type="text/css">
  <link href="/_stylesheets/docs.css" rel="stylesheet" type="text/css"/>
  <link href="/_stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css"/>
  <!--
  <link href="https://raw.githubusercontent.com/thedigitalgarage/origin-web-console/master/extensions/thedigitalgarage/css/main.css" rel="stylesheet" type="text/css">
  -->
  <link href="/_images/favicon.png" rel="apple-touch-icon-precomposed" type="image/png">
  <link href="/_images/favicon.png" rel="shortcut icon" type="text/css">
  <!--[if IE]><link rel="shortcut icon" href="https://assets.openshift.net/content/subdomain/favicon.ico"><![endif]-->
  <!-- or, set /favicon.ico for IE10 win -->
  <meta content="the Digital Garage" name="application-name">
  <meta content="#000000" name="msapplication-TileColor">
  <meta content="https://assets.openshift.net/content/subdomain/touch-icon-precomposed.png" name="msapplication-TileImage">
  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="https://assets.openshift.net/content/html5shiv.js" type="text/javascript"></script>
    <script src="https://assets.openshift.net/content/respond.js" type="text/javascript"></script>
    <link href="https://assets.openshift.net/content/vendor/respond-js/respond-proxy.html" id="respond-proxy" rel="respond-proxy">
    <link href="/_images/respond.proxy.gif" id="respond-redirect" rel="respond-redirect">
    <script src="/_javascripts/respond.proxy.js" type="text/javascript"></script>
  <![endif]-->
  <script src="https://assets.openshift.net/content/modernizr.js" type="text/javascript"></script>
  <script src="https://assets.openshift.net/content/subdomain.js" type="text/javascript"></script>
  <script src="/_javascripts/bootstrap-offcanvas.js" type="text/javascript"></script>
  <script src="https://assets.openshift.net/app/assets/site/tracking.js" type="text/javascript"></script>
  <script type="text/javascript" src="https://assets.openshift.net/app/assets/site/tracking.js"></script>
</head>
<body>
  <div class="navbar navbar-default navbar-openshift" role="navigation">
  <div class="navbar-header">
    <a class="navbar-brand" href="/"></a>
  </div>
  <div class="navbar-collapse collapse">
  </div>
</div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../../index.html">Atomic Registry Documentation</a>
      </li>
      <li class="hidden-xs active">
        <a href="../../registry_quickstart/index.html">Atomic Registry Latest</a>
      </li>
      <li class="hidden-xs active">
        <a href="../../install_config/adding_hosts_to_existing_cluster.html">Installation and Configuration</a>
      </li>
      <li class="hidden-xs active"><a href="../../install_config/advanced_ldap_configuration/index.html">Advanced LDAP Configuration</a></li>
      <li class="hidden-xs active">
        Setting up SSSD for LDAP Failover
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <div class="row-fluid">
          
<script>
  (function() {
    var cx = '013769182564158614814:e-dp46b51vk';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>

        </div>
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-right"></span>Quickstart
      </a>
      <ul id="topicGroup0" class="collapse  list-unstyled">
            <li><a class="" href="../../registry_quickstart/index.html">Overview</a></li>
            <li><a class="" href="../../registry_quickstart/developers.html">Developers</a></li>
            <li class="nav-header">
              <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicSubGroup-0-2">
                <span id="sgSpan-0-2" class="fa fa-caret-right"></span>&nbsp;Administrators
              </a>
              <ul id="topicSubGroup-0-2" class="nav-tertiary list-unstyled collapse">

                  <li><a class="" href="../../registry_quickstart/administrators/index.html">Overview</a></li>

                  <li><a class="" href="../../registry_quickstart/administrators/system_configuration.html">System Configuration</a></li>

                  <li><a class="" href="../../registry_quickstart/administrators/uninstall.html">Uninstall</a></li>
              </ul>
            </li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup1">
        <span id="tgSpan1" class="fa fa-angle-right"></span>Architecture
      </a>
      <ul id="topicGroup1" class="collapse  list-unstyled">
            <li class="nav-header">
              <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicSubGroup-1-0">
                <span id="sgSpan-1-0" class="fa fa-caret-right"></span>&nbsp;Core Concepts
              </a>
              <ul id="topicSubGroup-1-0" class="nav-tertiary list-unstyled collapse">

                  <li><a class="" href="../../architecture/core_concepts/containers_and_images.html">Images</a></li>

                  <li><a class="" href="../../architecture/core_concepts/projects_and_users.html">Projects and Users</a></li>

                  <li><a class="" href="../../architecture/core_concepts/builds_and_image_streams.html">Image Streams</a></li>
              </ul>
            </li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup2">
        <span id="tgSpan2" class="fa fa-angle-down"></span>Installation and Configuration
      </a>
      <ul id="topicGroup2" class="collapse in list-unstyled">
            <li><a class="" href="../../install_config/adding_hosts_to_existing_cluster.html">Adding Hosts to an Existing Cluster</a></li>
            <li><a class="" href="../../install_config/certificate_customization.html">Configuring Custom Certificates</a></li>
            <li><a class="" href="../../install_config/redeploying_certificates.html">Redeploying Certificates</a></li>
            <li><a class="" href="../../install_config/configuring_authentication.html">Configuring Authentication and User Agent</a></li>
            <li><a class="" href="../../install_config/syncing_groups_with_ldap.html">Syncing Groups With LDAP</a></li>
            <li class="nav-header">
              <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicSubGroup-2-5">
                <span id="sgSpan-2-5" class="fa fa-caret-down"></span>&nbsp;Advanced LDAP Configuration
              </a>
              <ul id="topicSubGroup-2-5" class="nav-tertiary list-unstyled collapse in">

                  <li><a class="" href="../../install_config/advanced_ldap_configuration/index.html">Overview</a></li>

                  <li><a class=" active" href="../../install_config/advanced_ldap_configuration/sssd_for_ldap_failover.html">Setting up SSSD for LDAP Failover</a></li>

                  <li><a class="" href="../../install_config/advanced_ldap_configuration/configuring_form_based_authentication.html">Configuring Form-Based Authentication</a></li>

                  <li><a class="" href="../../install_config/advanced_ldap_configuration/configuring_extended_ldap_attributes.html">Configuring Extended LDAP Attributes</a></li>
              </ul>
            </li>
            <li><a class="" href="../../install_config/web_console_customization.html">Customizing the Web Console</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup3">
        <span id="tgSpan3" class="fa fa-angle-right"></span>Cluster Administration
      </a>
      <ul id="topicGroup3" class="collapse  list-unstyled">
            <li><a class="" href="../../admin_guide/index.html">Overview</a></li>
            <li><a class="" href="../../admin_guide/manage_users.html">Managing Users</a></li>
            <li><a class="" href="../../admin_guide/managing_projects.html">Managing Projects</a></li>
            <li><a class="" href="../../admin_guide/managing_pods.html">Managing Pods</a></li>
            <li><a class="" href="../../admin_guide/service_accounts.html">Configuring Service Accounts</a></li>
            <li><a class="" href="../../admin_guide/manage_authorization_policy.html">Managing Authorization Policies</a></li>
            <li><a class="" href="../../admin_guide/image_policy.html">Image Policy</a></li>
            <li><a class="" href="../../admin_guide/quota.html">Setting Quotas</a></li>
            <li><a class="" href="../../admin_guide/multiproject_quota.html">Setting Multi-Project Quotas</a></li>
            <li><a class="" href="../../admin_guide/limits.html">Setting Limit Ranges</a></li>
            <li><a class="" href="../../admin_guide/allocating_node_resources.html">Allocating Node Resources</a></li>
            <li><a class="" href="../../admin_guide/tcp_ingress_external_ports.html">Assigning Unique External IPs for Ingress Traffic</a></li>
            <li><a class="" href="../../admin_guide/backup_restore.html">Backup and Restore</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup4">
        <span id="tgSpan4" class="fa fa-angle-right"></span>User Guide
      </a>
      <ul id="topicGroup4" class="collapse  list-unstyled">
            <li><a class="" href="../../dev_guide/index.html">Overview</a></li>
            <li><a class="" href="../../dev_guide/authentication.html">Authentication</a></li>
            <li><a class="" href="../../dev_guide/managing_images.html">Managing Images</a></li>
            <li><a class="" href="../../dev_guide/service_accounts.html">Service Accounts</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup5">
        <span id="tgSpan5" class="fa fa-angle-right"></span>CLI Reference
      </a>
      <ul id="topicGroup5" class="collapse  list-unstyled">
            <li><a class="" href="../../cli_reference/index.html">Overview</a></li>
            <li><a class="" href="../../cli_reference/get_started_cli.html">Get Started with the CLI</a></li>
            <li><a class="" href="../../cli_reference/manage_cli_profiles.html">Managing CLI Profiles</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="javascript:void(0);" data-toggle="collapse" data-target="#topicGroup6">
        <span id="tgSpan6" class="fa fa-angle-right"></span>REST API Reference
      </a>
      <ul id="topicGroup6" class="collapse  list-unstyled">
            <li><a class="" href="../../rest_api/index.html">Overview</a></li>
            <li><a class="" href="../../rest_api/openshift_v1.html">OpenShift v1</a></li>
            <li><a class="" href="../../rest_api/kubernetes_v1.html">Kubernetes v1</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>Setting up SSSD for LDAP Failover</h2>
        </div>
        <div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title"></div>
<ul class="sectlevel1">
<li><a href="#overview">Overview</a></li>
<li><a href="#sssd-prerequisites-for-authenticating-proxy-setup">Prerequisites for Authenticating Proxy Setup</a></li>
<li><a href="#sssd-phase-1-certificate-generation">Phase 1: Certificate Generation</a></li>
<li><a href="#sssd-phase-2-authenticating-proxy-setup">Phase 2: Authenticating Proxy Setup</a>
<ul class="sectlevel2">
<li><a href="#phase-2-step-1-copy-certificates">Step 1: Copy Certificates</a></li>
<li><a href="#phase-2-step-2-sssd-configuration">Step 2: SSSD Configuration</a></li>
<li><a href="#phase-2-step-3-apache-configuration">Step 3: Apache Configuration</a></li>
</ul>
</li>
<li><a href="#sssd-phase-3-openshift-configuration">Phase 3: Atomic Registry Configuration</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Atomic Registry provides an
<a href="../configuring_authentication.html#LDAPPasswordIdentityProvider">authentication
provider</a> for use with Lightweight Directory Access Protocol (LDAP) setups, but
it can only connect to a single LDAP server. This can be problematic if that
LDAP server becomes unavailable. System Security Services Daemon (SSSD) can be
used to solve the issue.</p>
</div>
<div class="paragraph">
<p>Originally designed to manage local and remote authentication to the host
operating system, SSSD can now be configured to provide identity,
authentication, and authorization services to web services like Atomic Registry.
SSSD provides advantages over the built-in LDAP provider, including the ability
to connect to any number of failover LDAP servers, as well as the ability to
cache authentication attempts in case it can no longer reach any of those
servers.</p>
</div>
<div class="paragraph">
<p>The setup for this configuration is advanced and requires a separate
authentication server (also called an <strong>authenticating proxy</strong>) for
Atomic Registry to communicate with. This topic describes how to do this setup
on a dedicated physical or virtual machine (VM), but the concepts are also
applicable to a setup in a container.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sssd-prerequisites-for-authenticating-proxy-setup"><a class="anchor" href="#sssd-prerequisites-for-authenticating-proxy-setup"></a>Prerequisites for Authenticating Proxy Setup</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Before starting setup, you need to know the following information about your
LDAP server.</p>
<div class="ulist">
<ul>
<li>
<p>Whether the directory server is powered by
<a href="http://www.freeipa.org/page/Main_Page">FreeIPA</a>, Active Directory, or another
LDAP solution.</p>
</li>
<li>
<p>The Uniform Resource Identifier (URI) for the LDAP server (for example,
ldap.example.com).</p>
</li>
<li>
<p>The location of the CA certificate for the LDAP server.</p>
</li>
<li>
<p>Whether the LDAP server corresponds to RFC 2307 or RFC2307bis for user groups.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Prepare the VMs:</p>
<div class="ulist">
<ul>
<li>
<p><strong><em>proxy.example.com</em></strong>: A VM to use as the authenticating proxy. This machine must
have at least SSSD 1.12.0 available, which means a fairly recent operating
system. This topic uses a Red Hat Enterprise Linux 7.2 server for its examples.</p>
</li>
<li>
<p><strong><em>openshift.example.com</em></strong>: A VM to use to run Atomic Registry.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These VMs can be configured to run on the same system, but for the examples used
in this topic they are kept separate.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sssd-phase-1-certificate-generation"><a class="anchor" href="#sssd-phase-1-certificate-generation"></a>Phase 1: Certificate Generation</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To ensure that communication between the authenticating proxy and
Atomic Registry is trustworthy, create a set of Transport Layer Security (TLS)
certificates to use during the other phases of this setup. In the
Atomic Registry system, start by using the auto-generated certificates created
as part of running:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap"># openshift start \
    --public-master=https://openshift.example.com:8443 \
    --write-config=/etc/origin/</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Among other things, this generates a <strong><em>/etc/origin/master/ca.{cert|key}</em></strong>. Use
this signing certificate to generate keys to use on the authenticating proxy.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mkdir -p /etc/origin/proxy/
# oadm ca create-server-cert \
    --cert='/etc/origin/proxy/proxy.example.com.crt' \
    --key='/etc/origin/proxy/proxy.example.com.key' \
    --hostnames=proxy.example.com \
    --signer-cert=/etc/origin/master/ca.crt \
    --signer-key='/etc/origin/master/ca.key' \
    --signer-serial='/etc/origin/master/ca.serial.txt'</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Ensure that any host names and interface IP addresses that need to access the
proxy are listed. Otherwise, the HTTPS connection will fail.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Generate the API client certificate that the authenticating proxy will use
to prove its identity to Atomic Registry:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap"># oadm create-api-client-config \
    --certificate-authority='/etc/origin/proxy/proxyca.crt' \ --client-dir='/etc/origin/proxy' \ --signer-cert='/etc/origin/proxy/proxyca.crt' \ --signer-key='/etc/origin/proxy/proxyca.key' \ --signer-serial='/etc/origin/proxy/proxyca.serial.txt' \ --user='system:proxy'</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Copy the certificate and key information to the appropriate file for future
steps:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap"># cat /etc/origin/proxy/system:proxy.crt /etc/origin/proxy/system:proxy.key &gt; /etc/origin/proxy/authproxy.pem</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This prevents malicious users from impersonating the proxy and sending fake
identities.</p>
</div>
</li>
<li>
<p>Create a new CA to sign this client certificate:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap"># mkdir -p /etc/origin/proxy/
# oadm ca create-server-cert \
    --cert='/etc/origin/proxy/proxy.example.com.crt' \
    --key='/etc/origin/proxy/proxy.example.com.key' \
    --hostnames=proxy.example.com,1.2.3.4 \
    --signer-cert=/etc/origin/master/ca.crt \
    --signer-key='/etc/origin/master/ca.key' \
    --signer-serial='/etc/origin/master/ca.serial.txt'</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Make <code><strong>UNIQUESTRING</strong>`</code> something unique:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap"># oadm ca create-signer-cert \
  --cert='/etc/origin/proxy/proxyca.crt' \
  --key='/etc/origin/proxy/proxyca.key' \
  --name='openshift-proxy-signer@UNIQUESTRING' \
  --serial='/etc/origin/proxy/proxyca.serial.txt'</pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sssd-phase-2-authenticating-proxy-setup"><a class="anchor" href="#sssd-phase-2-authenticating-proxy-setup"></a>Phase 2: Authenticating Proxy Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section guides you through the steps to authenticate the proxy setup.</p>
</div>
<div class="sect2">
<h3 id="phase-2-step-1-copy-certificates"><a class="anchor" href="#phase-2-step-1-copy-certificates"></a>Step 1: Copy Certificates</h3>
<div class="paragraph">
<p>From <strong><em>openshift.example.com</em></strong>, securely copy the necessary certificates to the
proxy machine:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap"># scp /etc/origin/master/ca.crt \
      root@proxy.example.com:/etc/pki/CA/certs/

# scp /etc/origin/proxy/proxy.example.com.crt \
      /etc/origin/proxy/authproxy.pem \
      root@proxy.example.com:/etc/pki/tls/certs/

# scp /etc/origin/proxy/proxy.example.com.key \
      root@proxy.example.com:/etc/pki/tls/private/</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="phase-2-step-2-sssd-configuration"><a class="anchor" href="#phase-2-step-2-sssd-configuration"></a>Step 2: SSSD Configuration</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install a new VM with an operating system that includes 1.12.0 or later so
that you can use the <strong>mod_identity_lookup</strong> module. The examples in this topic
use a Red Hat Enterprise Linux 7.2 Server.</p>
</li>
<li>
<p>Install all of the necessary dependencies:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install -y sssd \
                 sssd-dbus \
                 realmd \
                 httpd \
                 mod_session \
                 mod_ssl \
                 mod_lookup_identity \
                 mod_authnz_pam</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This gives you the needed SSSD and the web server components.</p>
</div>
</li>
<li>
<p>Edit the /etc/httpd/conf.modules.d/55-authnz_pam.conf file and remove the comment from the following:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap">LoadModule authnz_pam_module modules/mod_authnz_pam.so</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Set up SSSD to authenticate this VM against the LDAP server. If the LDAP server
is a FreeIPA or Active Directory environment, then <strong>realmd</strong> can be used to join
this machine to the domain.</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap"># realm join ldap.example.com</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For more advanced case, see the
<a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System-Level_Authentication_Guide/authconfig-ldap.html">System-Level Authentication Guide</a></p>
</div>
<div class="paragraph">
<p>If you want to use SSSD to manage failover situations for LDAP, this can be
configured by adding additional entries in <strong><em>/etc/sssd/sssd.conf</em></strong> on the
<strong>ldap_uri</strong> line. Systems enrolled with FreeIPA can automatically handle
failover using DNS SRV records.</p>
</div>
</li>
<li>
<p>Restart SSSD to ensure that all of the changes are applied properly:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ systemctl restart sssd.service</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Test that the user information can be retrieved properly:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ getent passwd &lt;username&gt;
username:*:12345:12345:Example User:/home/username:/usr/bin/bash</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Attempt to log into the VM as an LDAP user and confirm that the authentication
is properly set up. This can be done via the local console or a remote service
such as SSH.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you do not want LDAP users to be able to log into this machine, it is
recommended to modify <strong><em>/etc/pam.d/system-auth</em></strong> and
<strong><em>/etc/pam.d/password-auth</em></strong> to remove the lines containing <strong>pam_sss.so</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="phase-2-step-3-apache-configuration"><a class="anchor" href="#phase-2-step-3-apache-configuration"></a>Step 3: Apache Configuration</h3>
<div class="paragraph">
<p>You need to set up Apache to communicate with SSSD. Create a PAM stack file for
use with Apache. To do so:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the <strong><em>/etc/pam.d/openshift</em></strong> file and add the
following contents:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap">auth required pam_sss.so
account required pam_sss.so</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This configuration enables PAM (the pluggable authentication module) to use
<strong>pam_sss.so</strong> to determine authentication and access control when an
authentication request is issued for the <strong>openshift</strong> stack.</p>
</div>
</li>
<li>
<p>Configure the Apache <strong><em>httpd.conf</em></strong>. The steps in this section focus on
setting up the challenge authentication, which is useful for logging in with <code>oc
login</code> and similar automated tools.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="../advanced_ldap_configuration/configuring_form_based_authentication.html#configuring-form-based-authentication">Configuring
Form-Based Authentication</a> explains how to set up a graphical login using SSSD
as well, but it requires the rest of this setup as a prerequisite.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create the new file <strong><em>openshift-proxy.conf</em></strong> in <strong><em>/etc/httpd/conf.d</em></strong>
(substituting the correct host names where indicated):</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap">LoadModule request_module modules/mod_request.so
LoadModule lookup_identity_module modules/mod_lookup_identity.so
# Nothing needs to be served over HTTP.  This virtual host simply redirects to
# HTTPS.
&lt;VirtualHost *:80&gt;
  DocumentRoot /var/www/html
  RewriteEngine              On
  RewriteRule     ^(.*)$     https://%{HTTP_HOST}$1 [R,L]
&lt;/VirtualHost&gt;

&lt;VirtualHost *:443&gt;
  # This needs to match the certificates you generated.  See the CN and X509v3
  # Subject Alternative Name in the output of:
  # openssl x509 -text -in /etc/pki/tls/certs/proxy.example.com.crt
  ServerName proxy.example.com

  DocumentRoot /var/www/html
  SSLEngine on
  SSLCertificateFile /etc/pki/tls/certs/proxy.example.com.crt
  SSLCertificateKeyFile /etc/pki/tls/private/proxy.example.com.key
  SSLCACertificateFile /etc/pki/CA/certs/ca.crt

  # Send logs to a specific location to make them easier to find
  ErrorLog logs/proxy_error_log
  TransferLog logs/proxy_access_log
  LogLevel warn
  SSLProxyEngine on
  SSLProxyCACertificateFile /etc/pki/CA/certs/ca.crt
  # It's critical to enforce client certificates on the Master.  Otherwise
  # requests could spoof the X-Remote-User header by accessing the Master's
  # /oauth/authorize endpoint directly.
  SSLProxyMachineCertificateFile /etc/pki/tls/certs/authproxy.pem

  # Send all requests to the console
  RewriteEngine              On
  RewriteRule     ^/console(.*)$     https://%{HTTP_HOST}:8443/console$1 [R,L]

  # In order to using the challenging-proxy an X-Csrf-Token must be present.
  RewriteCond %{REQUEST_URI} ^/challenging-proxy
  RewriteCond %{HTTP:X-Csrf-Token} ^$ [NC]
  RewriteRule ^.* - [F,L]

  &lt;Location /challenging-proxy/oauth/authorize&gt;
    # Insert your backend server name/ip here.
    ProxyPass https://openshift.example.com:8443/oauth/authorize
    AuthType Basic
    AuthBasicProvider PAM
    AuthPAMService openshift
    Require valid-user
  &lt;/Location&gt;

  &lt;ProxyMatch /oauth/authorize&gt;
    AuthName openshift
    RequestHeader set X-Remote-User %{REMOTE_USER}s
  &lt;/ProxyMatch&gt;
&lt;/VirtualHost&gt;

RequestHeader unset X-Remote-User</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="../advanced_ldap_configuration/configuring_form_based_authentication.html#configuring-form-based-authentication">Configuring
Form-Based Authentication</a> explains how to add the <strong>login-proxy</strong> block to
support form authentication.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Set a boolean to tell SELinux that it is acceptable for Apache to contact the
PAM subsystem:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap"># setsebool -P allow_httpd_mod_auth_pam on</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Start up Apache:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl start httpd.service</pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sssd-phase-3-openshift-configuration"><a class="anchor" href="#sssd-phase-3-openshift-configuration"></a>Phase 3: Atomic Registry Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to set up an Atomic Registry server from scratch in
an "all in one" configuration.
<a href="../master_node_configuration.html#install-config-master-node-configuration">Master and Node
Configuration</a> provides more information on alternate configurations.</p>
</div>
<div class="paragraph">
<p>Modify the default configuration to use the new identity provider just
created. To do so:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Modify the <strong><em>/etc/origin/master/master-config.yaml</em></strong> file.</p>
</li>
<li>
<p>Scan through it and locate the <strong>identityProviders</strong> section and replace it with:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap">  identityProviders:
  - name: any_provider_name
    challenge: true
    login: false
    mappingMethod: claim
    provider:
      apiVersion: v1
      kind: RequestHeaderIdentityProvider
      challengeURL: "https://proxy.example.com/challenging-proxy/oauth/authorize?${query}"
      clientCA: /etc/origin/master/proxy/proxyca.crt
      headers:
      - X-Remote-User</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="../advanced_ldap_configuration/configuring_form_based_authentication.html#configuring-form-based-authentication">Configuring
Form-Based Authentication</a> explains how to add the login URL to support web
logins.</p>
</div>
<div class="paragraph">
<p><a href="../advanced_ldap_configuration/configuring_extended_ldap_attributes.html#configuring-extended-ldap-attributes">Configuring
Extended LDAP Attributes</a> explains how to add the email and full-name
attributes. Note that the full-name attributes are only stored to the database
on the first login.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Start Atomic Registry with the updated configuration:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap"># openshift start \
    --public-master=https://openshift.example.com:8443 \
    --master-config=/etc/origin/master/master-config.yaml \
    --node-config=/etc/origin/node-node1.example.com/node-config.yaml</pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Test logins:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="nowrap">oc login https://openshift.example.com:8443</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It should now be possible to log in with only valid LDAP credentials.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
      </div>
    </div>
  </div>
  <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
    <footer class="footer-openshift">
  <div class="container">
    <div class="row">
      <div class="col-xs-12 col-sm-4 col-md-3">
      </div>
      <div class="col-xs-12 col-sm-4 col-md-6 text-center">
        <div class="row">
          <div class="col-xs-12 col-md-4">
          </div>
          <div class="col-xs-12 col-md-4">
          </div>
          <div class="col-xs-12 col-md-4">
          </div>
        </div>
      </div>
      <div class="col-xs-12 col-sm-4 col-md-3 text-right">
        <a id="built_with_asciibinder" href="http://asciibinder.org/">
          <img src="http://docs.thedigitalgarage.io/_images/asciibinder_web_logo.svg" alt="AsciiBinder" />
        </a>
      </div>
    </div>
  </div>
</footer>
</body>
</html>